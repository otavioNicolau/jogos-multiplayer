<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake ‚Äî Endless + Multiplayer (cliente)</title>
  <style>
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;background:#0b1020;color:#fff;font-family:system-ui,Arial}
    .wrap{display:grid;gap:10px;place-items:center;max-width:960px;padding:10px}
    canvas{background:#0f0f17;border:2px solid #2a2a2a;border-radius:8px;image-rendering: pixelated}
    .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    input,button{background:#1b1f3a;color:#fff;border:1px solid #2f3568;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    label{font-size:12px;color:#a7b}
    .hud{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .card{background:#121534;border:1px solid #2f3568;border-radius:10px;padding:8px 12px}
    .pill{padding:2px 8px;border-radius:999px;background:#1c2050;border:1px solid #2b3174;color:#cfe}
    #msg{min-height:1.2em;color:#9fd}
    .touch{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;width:220px;margin-top:8px}
    .touch .ghost{visibility:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üêç Cobrinha ‚Äî Tela sem fim + Multiplayer (cliente)</h1>

    <div class="row">
      <div class="card">
        <div><label>Servidor WS</label></div>
        <input id="wsurl" size="28" value="ws://localhost:8080" />
      </div>
      <div class="card">
        <div><label>Seu nome</label></div>
        <input id="playername" size="14" placeholder="Jogador" />
      </div>
      <button id="connect">Conectar</button>
      <button id="start" disabled>Iniciar</button>
      <button id="pause" disabled>Pausar</button>
      <button id="reset" disabled>Desistir</button>
    </div>

    <div class="hud">
      <div class="pill">Pontos: <b id="score">0</b></div>
      <div class="pill">Jogadores: <b id="pcount">0</b></div>
      <div class="pill">Ping: <b id="ping">--</b> ms</div>
      <div class="pill">Mundo: <b id="world">--</b></div>
    </div>

    <canvas id="c" width="640" height="480" aria-label="tabuleiro"></canvas>
    <div id="msg"></div>
    <small>Controles: setas / WASD ‚Äî Espa√ßo: Pausa
      ‚Ä¢ O mundo √© infinito (wrap): sair pela direita entra pela esquerda, etc.
    </small>

    <div class="touch">
      <button data-dir="up">‚¨ÜÔ∏è</button>
      <div class="ghost"></div>
      <button data-dir="right">‚û°Ô∏è</button>
      <button data-dir="left">‚¨ÖÔ∏è</button>
      <div class="ghost"></div>
      <button data-dir="down">‚¨áÔ∏è</button>
    </div>
  </div>

  <script>
    // ========== CLIENTE MULTIPLAYER ==========
    const cvs = document.getElementById('c');
    const ctx = cvs.getContext('2d');
    const scoreEl = document.getElementById('score');
    const pcountEl= document.getElementById('pcount');
    const pingEl  = document.getElementById('ping');
    const worldEl = document.getElementById('world');
    const msgEl   = document.getElementById('msg');

    const wsUrlEl = document.getElementById('wsurl');
    const nameEl  = document.getElementById('playername');
    const btnConn = document.getElementById('connect');
    const btnStart= document.getElementById('start');
    const btnPause= document.getElementById('pause');
    const btnReset= document.getElementById('reset');

    const touchBtns = document.querySelectorAll('.touch [data-dir]');

    let ws, myId = null, connected = false, running = false;

    // estado sincronizado pelo servidor
    let WORLD = {w:60, h:60};
    const CELL  = 24; // pixels por c√©lula
    let players = {}; // id -> {x,y,body:[...], color, name, score}
    let apples = []; // [{x,y,id}]

    // c√¢mera (segue o jogador local) com wrap infinito
    function worldToScreen(x,y){
      const me = players[myId];
      const vx = me ? me.x : 0, vy = me ? me.y : 0;
      const sx = Math.floor(cvs.width/2/CELL);
      const sy = Math.floor(cvs.height/2/CELL);
      const dx = ((x - vx + WORLD.w*1.5) % WORLD.w) - WORLD.w/2;
      const dy = ((y - vy + WORLD.h*1.5) % WORLD.h) - WORLD.h/2;
      return {px: (sx+dx)*CELL, py: (sy+dy)*CELL};
    }

    function drawCell(x,y,color){
      const {px,py} = worldToScreen(x,y);
      ctx.fillStyle = color;
      ctx.fillRect(Math.round(px), Math.round(py), CELL-1, CELL-1);
    }

    function render(){
      ctx.fillStyle = '#0f0f17';
      ctx.fillRect(0,0,cvs.width,cvs.height);
      apples.forEach(a=> drawCell(a.x, a.y, '#ffcc00'));
      Object.values(players).forEach(p=>{
        p.body.forEach((seg,i)=> drawCell(seg.x, seg.y, i===0? '#fff' : p.color));
      });
    }

    // input -> servidor
    let lastDir = {x:1,y:0};
    function sendDir(nx,ny){
      if(!connected) return;
      // evita revers√£o imediata
      if(lastDir && nx === -lastDir.x && ny === -lastDir.y) return;
      lastDir = {x:nx,y:ny};
      ws.send(JSON.stringify({type:'dir', x:nx, y:ny}));
    }

    window.addEventListener('keydown', (e)=>{
      const k=e.key.toLowerCase();
      if(["arrowup","w"].includes(k)) sendDir(0,-1);
      else if(["arrowdown","s"].includes(k)) sendDir(0,1);
      else if(["arrowleft","a"].includes(k)) sendDir(-1,0);
      else if(["arrowright","d"].includes(k)) sendDir(1,0);
      else if(k===' '){ togglePause(); }
    });
    touchBtns.forEach(b=> b.addEventListener('click', ()=>{
      const d=b.dataset.dir;
      if(d==='up')sendDir(0,-1);
      if(d==='down')sendDir(0,1);
      if(d==='left')sendDir(-1,0);
      if(d==='right')sendDir(1,0);
    }));

    // render loop (estado vem do servidor)
    function loop(){ requestAnimationFrame(loop); render(); }
    requestAnimationFrame(loop);

    // WebSocket
    btnConn.addEventListener('click', ()=>{
      if(connected){ ws.close(); return; }
      connect();
    });

    btnStart.addEventListener('click', ()=>{ if(connected){ ws.send(JSON.stringify({type:'start'})); running=true; } });
    btnPause.addEventListener('click', ()=> togglePause());
    btnReset.addEventListener('click', ()=>{ if(connected){ ws.send(JSON.stringify({type:'reset'})); } });

    function togglePause(){
      if(!connected) return;
      running = !running;
      ws.send(JSON.stringify({type: running?'resume':'pause'}));
    }

    function connect(){
      const url = wsUrlEl.value.trim();
      ws = new WebSocket(url);
      msg('Conectando‚Ä¶');

      ws.onopen = ()=>{
        connected = true;
        btnConn.textContent='Desconectar';
        btnStart.disabled=false; btnPause.disabled=false; btnReset.disabled=false;
        const name = nameEl.value.trim() || `Player-${Math.floor(Math.random()*1000)}`;
        ws.send(JSON.stringify({type:'hello', name}));
        ping();
      };
      ws.onclose = ()=>{
        connected=false; btnConn.textContent='Conectar'; msg('Desconectado.');
      };
      ws.onerror = ()=> msg('Erro de conex√£o. Confira o servidor/URL.');

      ws.onmessage = (ev)=>{
        const data = JSON.parse(ev.data);
        if(data.type==='init'){
          myId = data.id; WORLD = data.world; apples = data.apples; players = data.players;
          document.title = `Snake ‚Äî ${WORLD.w}x${WORLD.h}`;
          worldEl.textContent=`${WORLD.w}x${WORLD.h}`;
          updateHUD();
        } else if(data.type==='state'){
          apples = data.apples; players = data.players; updateHUD();
        } else if(data.type==='msg'){
          msg(data.text);
        } else if(data.type==='pong'){
          const now = performance.now(); pingEl.textContent = Math.round(now - data.t);
        }
      };
    }

    function updateHUD(){
      pcountEl.textContent = Object.keys(players).length;
      const me = players[myId]; scoreEl.textContent = me ? me.score : 0;
    }

    function msg(t){ msgEl.textContent=t; }

    // ping cont√≠nuo
    function ping(){
      if(!connected) return;
      ws.send(JSON.stringify({type:'ping', t: performance.now()}));
      setTimeout(ping, 1000);
    }
  </script>
</body>
</html>
